# Архитектура и системная аналитика: Yandex GPT AI Ассистент

## 1. Общая архитектурная схема
```
┌─────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   Пользователь  │◄──►│  Telegram Bot    │◄──►│  Yandex Cloud AI │
│    (Telegram)   │    │   (Aiogram)      │    │   (Yandex GPT)   │
└─────────────────┘    └──────────────────┘    └──────────────────┘
                              │
                              │
                      ┌──────────────────┐
                      │  In-Memory       │
                      │  Storage         │
                      │  (History)       │
                      └──────────────────┘
```

## 2. Компоненты системы

### 2.1. Presentation Layer (Уровень представления)
**Telegram Bot Interface** - интерфейс взаимодействия с пользователем через Telegram
- Обработка команд (/start, /help, /menu, /status, /history)
- Управление клавиатурами и меню
- Отображение ответов в формате HTML

**Reply Keyboard Builder** - система интерактивных меню
- Главное меню с 3 кнопками
- Контекстные меню для разных режимов

### 2.2. Business Logic Layer (Бизнес-логика)
```
┌────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Message       │    │   Dialog Manager │    │   AI Gateway    │
│  Handlers      │───►│   (History)      │───►│  (Yandex GPT)   │
└────────────────┘    └──────────────────┘    └─────────────────┘
```

**Message Handlers** - обработчики входящих сообщений
- Командные обработчики (6 команд)
- Текстовые обработчики
- Обработчики кнопок меню

**Dialog Manager** - управление диалогами и историей
- Хранение истории сообщений (до 10 на пользователя)
- Автоочистка старых диалогов (таймаут 1 час)
- Контекстное управление беседой

**AI Gateway** - шлюз к Yandex GPT API
- Формирование промптов с историей
- Обработка ошибок API
- Управление параметрами генерации

### 2.3. Data Layer (Уровень данных)
**In-Memory Storage** - временное хранилище в оперативной памяти
- Хранение истории диалогов по user_id
- Автоматическая очистка по таймауту
- Ограничение длины истории

## 3. Технологический стек

### 3.1. Backend Technologies
**Язык программирования**: Python 3.8+
**Асинхронный фреймворк**: Aiogram 3.x
**HTTP-клиент**: aiohttp 3.8+
**Логирование**: logging (стандартная библиотека)

### 3.2. AI & Cloud Services
**AI-провайдер**: Yandex Cloud AI (Yandex GPT Lite)
**API-эндпоинт**: https://llm.api.cloud.yandex.net/foundationModels/v1/completion
**Платформа бота**: Telegram Bot API

### 3.3. Data Management
**Хранилище**: In-memory (defaultdict)
**Сериализация**: JSON для API-запросов
**Кэширование**: RAM-based session storage

## 4. Модели данных

### 4.1. Модель сообщения
```python
Message:
  role: str          # 'user' или 'assistant'
  text: str          # текст сообщения
  timestamp: datetime # метка времени
```

### 4.2. Модель диалога
```python
UserDialog:
  user_id: int       # идентификатор пользователя Telegram
  messages: List[Message] # история сообщений (max 10)
  last_activity: datetime # время последней активности
```

### 4.3. Модель API-запроса
```python
GPTRequest:
  modelUri: str      # URI модели Yandex GPT
  completionOptions: dict # параметры генерации
  messages: List[dict]    # системные и пользовательские сообщения
```

## 5. API и интеграции

### 5.1. Внутренние API
**Telegram Bot API** - обработка входящих сообщений и команд
**Dialog Management API** - управление историей диалогов

### 5.2. Внешние интеграции
**Yandex Cloud AI API** - интеграция с Yandex GPT для генерации ответов
**Telegram Bot API** - платформа для взаимодействия с пользователями

## 6. Потоки данных

### 6.1. Основной поток обработки сообщения
```
1. Пользователь отправляет сообщение в Telegram
2. Aiogram получает сообщение и передает обработчику
3. Проверка типа сообщения (команда/текст/кнопка)
4. Для текстовых запросов - обращение к Yandex GPT
5. Формирование ответа с учетом истории диалога
6. Сохранение в историю и отправка ответа пользователю
```

### 6.2. Поток управления историей
```
1. При каждом запросе проверяется актуальность истории
2. Диалоги старше 1 часа автоматически очищаются
3. История ограничивается 10 последними сообщениями
4. При очистке истории - полное удаление данных пользователя
```

## 7. Масштабируемость и производительность

### 7.1. Требования к производительности
**Время ответа API**: < 30 секунд (таймаут Yandex GPT)
**Время обработки сообщения**: < 2 секунд
**Количество одновременных пользователей**: до 1000 (в текущей конфигурации)

### 7.2. Стратегия масштабирования
**Вертикальное масштабирование**: увеличение ресурсов сервера
**Горизонтальное масштабирование**: запуск нескольких инстансов бота
**Миграция хранилища**: переход с in-memory на Redis/PostgreSQL

## 8. Безопасность

### 8.1. Меры безопасности
**Аутентификация**: API keys для Telegram и Yandex Cloud
**Валидация входных данных**: проверка и очистка пользовательского ввода
**Ограничение доступа**: проверка прав сервисного аккаунта Yandex
**Таймауты запросов**: предотвращение зависаний

## 9. Мониторинг и логирование

### 9.1. Ключевые метрики
**Успешность API-запросов** к Yandex GPT
**Время ответа** для каждого запроса
**Количество активных пользователей** и диалогов
**Частота использования** различных команд

---

# User Stories: Yandex GPT AI Ассистент

## 1. Управление диалогом

### US-001: Начало работы с ботом
**Как новый пользователь,** я хочу получить приветственное сообщение и инструкции, чтобы быстро понять возможности бота.

**Сценарий:**
```text
1. Пользователь нажимает /start в Telegram
2. Бот отправляет приветственное сообщение с описанием функций
3. Бот показывает главное меню с кнопками
4. Пользователь видит все доступные возможности
```

### US-002: Поиск информации
**Как пользователь,** я хочу задавать вопросы и получать информативные ответы, чтобы быстро находить нужную информацию.

**Сценарий:**
```text
1. Пользователь нажимает кнопку "🔍 Поиск" или пишет вопрос
2. Бот подтверждает активацию режима поиска
3. Пользователь задает вопрос
4. Бот обрабатывает запрос через Yandex GPT
5. Пользователь получает краткий и информативный ответ
```

## 2. Управление историей и контекстом

### US-003: Просмотр истории диалога
**Как пользователь,** я хочу видеть историю текущего диалога, чтобы помнить контекст разговора.

**Сценарий:**
```text
1. Пользователь отправляет команду /history
2. Бот показывает последние 5 сообщений из истории
3. Пользователь видит полную историю текущей беседы
4. Отображается общее количество сообщений в истории
```

### US-004: Очистка истории диалога
**Как пользователь,** я хочу очищать историю диалога, чтобы начать новый разговор без старого контекста.

**Сценарий:**
```text
1. Пользователь нажимает кнопку "🧹 Очистить историю"
2. Бот полностью очищает историю диалога для этого пользователя
3. Бот подтверждает успешную очистку
4. Следующий вопрос обрабатывается без учета предыдущего контекста
```

## 3. Системная информация и помощь

### US-005: Получение справки
**Как пользователь,** я хочу получать подробную справку о возможностях бота, чтобы эффективно его использовать.

**Сценарий:**
```text
1. Пользователь отправляет команду /help
2. Бот отправляет подробное описание всех команд и функций
3. Пользователь видит список доступных команд и кнопок меню
4. Описывается функция памяти бота
```

### US-006: Проверка статуса системы
**Как технически подкованный пользователь,** я хочу проверять статус подключения к AI-сервисам, чтобы убедиться в работоспособности бота.

**Сценарий:**
```text
1. Пользователь отправляет команду /status
2. Бот проверяет подключение к Yandex GPT API
3. Бот выполняет тестовый запрос
4. Пользователь получает отчет о статусе подключения
```

### US-007: Просмотр информации о проекте
**Как любознательный пользователь,** я хочу узнать о технологиях и возможностях бота, чтобы понять его архитектуру.

**Сценарий:**
```text
1. Пользователь нажимает кнопку "ℹ️ Информация для проекта"
2. Бот отправляет детальную информацию о технологическом стеке
3. Пользователь видит используемые технологии и возможности
4. Указывается разработчик и особенности реализации
```

---

# Use Cases: Yandex GPT AI Ассистент

## UC-001: Обработка пользовательского вопроса
**Акторы:** Пользователь, Telegram Bot, Yandex GPT API
**Предусловия:** Бот запущен и доступен, Yandex GPT API доступен
**Постусловия:** Пользователь получает ответ, история диалога обновляется

### Основной поток:
1. Пользователь отправляет текстовое сообщение
2. Бот определяет, что это не команда меню
3. Бот отправляет статус "печатает"
4. Бот формирует запрос к Yandex GPT с учетом истории диалога
5. Yandex GPT обрабатывает запрос и возвращает ответ
6. Бот сохраняет вопрос и ответ в историю
7. Бот отправляет ответ пользователю

### Альтернативные потоки:
**A1: Ошибка API Yandex GPT**
1. Yandex GPT API возвращает ошибку
2. Бот обрабатывает ошибку и формирует понятное сообщение
3. Пользователь получает уведомление об ошибке

**A2: Таймаут запроса**
1. Запрос к Yandex GPT превышает 30 секунд
2. Бот прерывает запрос по таймауту
3. Пользователь получает сообщение о таймауте

## UC-002: Управление историей диалога
**Акторы:** Пользователь, Система хранения истории
**Предусловия:** Пользователь имеет активный диалог с ботом
**Постусловия:** История диалога соответствующим образом изменена

### Основной поток:
1. Пользователь отправляет команду /history
2. Бот извлекает историю диалога для этого пользователя
3. Бот форматирует историю для удобного просмотра
4. Пользователь получает историю последних сообщений

### Альтернативные потоки:
**A1: Пустая история**
1. История диалога для пользователя пуста
2. Бот сообщает, что история пуста
3. Пользователь получает соответствующее уведомление

**A2: Автоочистка старых диалогов**
1. Система проверяет время последней активности
2. Диалоги старше 1 часа автоматически удаляются
3. Освобождается память от неактивных диалогов

## UC-003: Навигация по меню бота
**Акторы:** Пользователь, Telegram Bot Interface
**Предусловия:** Пользователь начал диалог с ботом
**Постусловия:** Пользователь переходит в нужный режим работы

### Основной поток:
1. Пользователь нажимает кнопку в главном меню
2. Бот определяет выбранный режим
3. Бот изменяет интерфейс соответствующим образом
4. Пользователь получает подтверждение активации режима
5. Отображается контекстное меню для выбранного режима

### Альтернативные потоки:
**A1: Возврат в главное меню**
1. Пользователь нажимает "🏠 Главное меню"
2. Бот возвращает главное меню с основными кнопками
3. Пользователь может выбрать другой режим работы

## UC-004: Проверка системного статуса
**Акторы:** Пользователь, Yandex GPT API, Система мониторинга
**Предусловия:** Пользователь имеет доступ к командам бота
**Постусловия:** Пользователь получает информацию о статусе системы

### Основной поток:
1. Пользователь отправляет команду /status
2. Бот проверяет корректность настроек API ключей
3. Бот выполняет тестовый запрос к Yandex GPT
4. Бот анализирует ответ тестового запроса
5. Пользователь получает детальный отчет о статусе системы

### Альтернативные потоки:
**A1: Неправильные API ключи**
1. Бот обнаруживает тестовые или неправильные ключи
2. Бот сообщает о необходимости настройки ключей
3. Пользователь получает инструкцию по исправлению

**A2: Проблемы с подключением**
1. Yandex GPT API недоступен
2. Бот обнаруживает ошибку подключения
3. Пользователь получает информацию о проблеме с подключением